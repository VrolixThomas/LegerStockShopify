{% comment %}
  Metal Price Calculator - Dynamic pricing for custom sizes

  Usage: {% render 'metal-price-calculator' %}

  This calculator allows customers to input custom dimensions and get instant pricing.
  Configure pricing rules in the JavaScript section below.
{% endcomment %}

<div class="metal-calculator">
  <!-- Step 1: Material & Form -->
  <div class="calc-step">
    <div class="calc-step-header">
      <div class="calc-step-number">1</div>
      <h3 class="calc-step-title">Material & Form</h3>
    </div>
    <div class="calc-step-content">
      <div class="calc-field">
        <label for="calc-material" class="calc-label">Material</label>
        <select id="calc-material" class="calc-input calc-select">
          <option value="">Select Material</option>
          <option value="aluminium" data-price="3.50" data-density="2.7">Aluminium</option>
          <option value="iron" data-price="2.20" data-density="7.87">Iron</option>
          <option value="steel" data-price="2.50" data-density="7.85">Steel</option>
          <option value="inox" data-price="5.50" data-density="8.00">Stainless Steel (Inox)</option>
          <option value="copper" data-price="8.50" data-density="8.96">Copper</option>
        </select>
      </div>

      <div class="calc-field">
        <label for="calc-form" class="calc-label">Form/Shape</label>
        <select id="calc-form" class="calc-input calc-select">
          <option value="">Select Form</option>
          <option value="flat" data-calc-type="area">Flat Sheet</option>
          <option value="tube" data-calc-type="tube">Tube (Square/Rectangular)</option>
          <option value="round" data-calc-type="round">Round Bar</option>
          <option value="l-shape" data-calc-type="l-shape">L-Shape Angle</option>
          <option value="t-shape" data-calc-type="t-shape">T-Shape</option>
          <option value="square" data-calc-type="square-bar">Square Bar</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Step 2: Dimensions -->
  <div class="calc-step" id="dimensions-step" style="display: none;">
    <div class="calc-step-header">
      <div class="calc-step-number">2</div>
      <h3 class="calc-step-title">Dimensions</h3>
    </div>
    <div class="calc-step-content">
      <div id="dimension-fields" class="dimension-fields-grid">
        <!-- Fields will be dynamically inserted here -->
      </div>
    </div>
  </div>

  <!-- Step 3: Quantity -->
  <div class="calc-step" id="quantity-step" style="display: none;">
    <div class="calc-step-header">
      <div class="calc-step-number">3</div>
      <h3 class="calc-step-title">Quantity</h3>
    </div>
    <div class="calc-step-content">
      <div class="calc-field">
        <label for="calc-quantity" class="calc-label">Quantity</label>
        <input type="number" id="calc-quantity" class="calc-input" value="1" min="1" max="9999">
      </div>
      <button type="button" class="calc-calculate-btn" onclick="calculatePrice()">Calculate Price</button>
    </div>
  </div>

  <!-- Your Selection Summary -->
  <div class="calc-summary" id="calc-summary" style="display: none;">
    <h3 class="calc-summary-title">Your Selection</h3>
    <div class="calc-summary-content">
      <p class="calc-summary-product" id="summary-product">-</p>

      <div class="calc-summary-details">
        <div class="calc-summary-row">
          <span class="calc-summary-label">Quantity:</span>
          <span class="calc-summary-value" id="summary-quantity">-</span>
        </div>
        <div class="calc-summary-row">
          <span class="calc-summary-label">Dimensions:</span>
          <span class="calc-summary-value" id="summary-dimensions">-</span>
        </div>
        <div class="calc-summary-row">
          <span class="calc-summary-label">Total Weight:</span>
          <span class="calc-summary-value" id="summary-weight">-</span>
        </div>
        <div class="calc-summary-row">
          <span class="calc-summary-label">Price/Each:</span>
          <span class="calc-summary-value" id="summary-unit-price">-</span>
        </div>
        <div class="calc-summary-row calc-summary-total">
          <span class="calc-summary-label">Total Price*:</span>
          <span class="calc-summary-value" id="summary-total-price">-</span>
        </div>
      </div>

      <button type="button" class="calc-add-to-cart-btn" onclick="addCalculatedToCart()">
        Add To Cart
      </button>

      <small class="calc-note">*Shipping costs calculated in the shopping cart</small>
    </div>
  </div>

  <!-- Error Message -->
  <div class="calc-error" id="calc-error" style="display: none;"></div>
</div>

<script>
// Google Sheets URL for dynamic pricing
const GOOGLE_SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTlavfG1h-6v7KtR7duck9TFT2pCTKJcmYE_ac5qo-lBS67BNlVoInnuQ5zHMsWpDUfrOIufydqy-Bl/pub?output=csv';

// Pricing configuration (€ per kg) - fallback values if fetch fails
let PRICING_CONFIG = {
  aluminium: { pricePerKg: 3.50, density: 2.7 }, // g/cm³
  iron: { pricePerKg: 2.20, density: 7.87 },
  steel: { pricePerKg: 2.50, density: 7.85 },
  inox: { pricePerKg: 5.50, density: 8.00 },
  copper: { pricePerKg: 8.50, density: 8.96 }
};

// Minimum order surcharge
const MINIMUM_ORDER = { threshold: 10, surcharge: 5 }; // Add €5 if order < €10

// Fetch prices from Google Sheets
async function fetchPricesFromGoogleSheets() {
  try {
    const response = await fetch(GOOGLE_SHEETS_CSV_URL);
    const csvText = await response.text();

    // Parse CSV
    const lines = csvText.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim());

    // Find column indices (flexible matching)
    const materialIndex = headers.findIndex(h => h.toLowerCase().includes('material'));
    const priceIndex = headers.findIndex(h => {
      const lower = h.toLowerCase();
      return lower.includes('price') || lower.includes('priceperkg');
    });
    const densityIndex = headers.findIndex(h => h.toLowerCase().includes('density'));

    if (materialIndex === -1 || priceIndex === -1 || densityIndex === -1) {
      console.warn('Calculator: Google Sheets columns not found. Using fallback prices.');
      return;
    }

    // Parse data rows
    const newConfig = {};
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(',').map(v => v.trim());
      if (values.length >= 3) {
        const material = values[materialIndex].toLowerCase();
        const pricePerKg = parseFloat(values[priceIndex]);
        const density = parseFloat(values[densityIndex]);

        if (material && !isNaN(pricePerKg) && !isNaN(density)) {
          newConfig[material] = { pricePerKg, density };
        }
      }
    }

    // Update pricing config if we got valid data
    if (Object.keys(newConfig).length > 0) {
      PRICING_CONFIG = newConfig;
      console.log('Calculator: Prices updated from Google Sheets', PRICING_CONFIG);
    } else {
      console.warn('Calculator: No valid data in Google Sheets. Using fallback prices.');
    }
  } catch (error) {
    console.error('Calculator: Failed to fetch prices from Google Sheets:', error);
    console.log('Calculator: Using fallback prices');
  }
}

// Load prices on page load
fetchPricesFromGoogleSheets();

// Dimension field templates for different forms
const DIMENSION_TEMPLATES = {
  'flat': [
    { id: 'length', label: 'Length (mm)', placeholder: 'e.g., 2000', type: 'number' },
    { id: 'width', label: 'Width (mm)', placeholder: 'e.g., 1000', type: 'number' },
    { id: 'thickness', label: 'Thickness (mm)', placeholder: 'e.g., 3', type: 'number', step: '0.1' }
  ],
  'tube': [
    { id: 'length', label: 'Length (mm)', placeholder: 'e.g., 3000', type: 'number' },
    { id: 'width', label: 'Width (mm)', placeholder: 'e.g., 40', type: 'number' },
    { id: 'height', label: 'Height (mm)', placeholder: 'e.g., 40', type: 'number' },
    { id: 'wallThickness', label: 'Wall Thickness (mm)', placeholder: 'e.g., 2', type: 'number', step: '0.1' }
  ],
  'round': [
    { id: 'length', label: 'Length (mm)', placeholder: 'e.g., 3000', type: 'number' },
    { id: 'diameter', label: 'Diameter (mm)', placeholder: 'e.g., 25', type: 'number' }
  ],
  'l-shape': [
    { id: 'length', label: 'Length (mm)', placeholder: 'e.g., 3000', type: 'number' },
    { id: 'width1', label: 'Leg 1 Width (mm)', placeholder: 'e.g., 40', type: 'number' },
    { id: 'width2', label: 'Leg 2 Width (mm)', placeholder: 'e.g., 40', type: 'number' },
    { id: 'thickness', label: 'Thickness (mm)', placeholder: 'e.g., 3', type: 'number', step: '0.1' }
  ],
  't-shape': [
    { id: 'length', label: 'Length (mm)', placeholder: 'e.g., 3000', type: 'number' },
    { id: 'flangeWidth', label: 'Flange Width (mm)', placeholder: 'e.g., 60', type: 'number' },
    { id: 'webHeight', label: 'Web Height (mm)', placeholder: 'e.g., 40', type: 'number' },
    { id: 'thickness', label: 'Thickness (mm)', placeholder: 'e.g., 4', type: 'number', step: '0.1' }
  ],
  'square-bar': [
    { id: 'length', label: 'Length (mm)', placeholder: 'e.g., 3000', type: 'number' },
    { id: 'size', label: 'Square Size (mm)', placeholder: 'e.g., 20', type: 'number' }
  ]
};

// Calculate volume in cubic centimeters
function calculateVolume(form, dimensions) {
  const d = dimensions;

  switch(form) {
    case 'flat':
      // Volume = length × width × thickness (convert mm to cm)
      return (d.length / 10) * (d.width / 10) * (d.thickness / 10);

    case 'tube':
      // Hollow rectangular tube
      const outerVol = (d.length / 10) * (d.width / 10) * (d.height / 10);
      const innerVol = (d.length / 10) * ((d.width - 2 * d.wallThickness) / 10) * ((d.height - 2 * d.wallThickness) / 10);
      return outerVol - innerVol;

    case 'round':
      // Solid round bar: π × r² × length
      const radius = d.diameter / 2 / 10; // convert to cm
      return Math.PI * radius * radius * (d.length / 10);

    case 'l-shape':
      // L-shape: two rectangles minus overlap
      const leg1 = (d.length / 10) * (d.width1 / 10) * (d.thickness / 10);
      const leg2 = (d.length / 10) * (d.width2 / 10) * (d.thickness / 10);
      const overlap = (d.length / 10) * (d.thickness / 10) * (d.thickness / 10);
      return leg1 + leg2 - overlap;

    case 't-shape':
      // T-shape: flange + web minus overlap
      const flange = (d.length / 10) * (d.flangeWidth / 10) * (d.thickness / 10);
      const web = (d.length / 10) * (d.thickness / 10) * (d.webHeight / 10);
      return flange + web - ((d.length / 10) * (d.thickness / 10) * (d.thickness / 10));

    case 'square-bar':
      // Solid square bar
      return (d.length / 10) * (d.size / 10) * (d.size / 10);

    default:
      return 0;
  }
}

// Update dimension fields based on selected form
function updateDimensionFields() {
  const materialSelect = document.getElementById('calc-material');
  const formSelect = document.getElementById('calc-form');
  const selectedOption = formSelect.options[formSelect.selectedIndex];
  const calcType = selectedOption.dataset.calcType;
  const fieldsContainer = document.getElementById('dimension-fields');
  const dimensionsStep = document.getElementById('dimensions-step');
  const quantityStep = document.getElementById('quantity-step');
  const summary = document.getElementById('calc-summary');

  // Hide subsequent steps if material or form not selected
  if (!materialSelect.value || !calcType) {
    dimensionsStep.style.display = 'none';
    quantityStep.style.display = 'none';
    summary.style.display = 'none';
    return;
  }

  const template = DIMENSION_TEMPLATES[calcType];
  if (!template) {
    dimensionsStep.style.display = 'none';
    return;
  }

  // Build HTML for dimension fields
  let html = '';
  template.forEach(field => {
    html += `
      <div class="calc-field">
        <label for="calc-${field.id}" class="calc-label">${field.label}</label>
        <input
          type="${field.type}"
          id="calc-${field.id}"
          class="calc-input"
          placeholder="${field.placeholder}"
          ${field.step ? `step="${field.step}"` : ''}
          min="0.1"
        >
      </div>
    `;
  });

  fieldsContainer.innerHTML = html;
  dimensionsStep.style.display = 'block';
  quantityStep.style.display = 'block';
  summary.style.display = 'none';
}

// Calculate and display price
function calculatePrice() {
  const material = document.getElementById('calc-material').value;
  const form = document.getElementById('calc-form').value;
  const quantity = parseInt(document.getElementById('calc-quantity').value) || 1;

  const errorDiv = document.getElementById('calc-error');

  // Validate selections
  if (!material || !form) {
    hideResult();
    return;
  }

  const formSelect = document.getElementById('calc-form');
  const calcType = formSelect.options[formSelect.selectedIndex].dataset.calcType;
  const template = DIMENSION_TEMPLATES[calcType];

  if (!template) {
    hideResult();
    return;
  }

  // Collect dimensions
  const dimensions = {};
  let allFieldsFilled = true;

  template.forEach(field => {
    const input = document.getElementById(`calc-${field.id}`);
    const value = parseFloat(input.value);

    if (!value || value <= 0) {
      allFieldsFilled = false;
    }
    dimensions[field.id] = value || 0;
  });

  if (!allFieldsFilled) {
    hideResult();
    return;
  }

  // Calculate volume in cm³
  const volumeCm3 = calculateVolume(calcType, dimensions);

  if (volumeCm3 <= 0) {
    showError('Invalid dimensions. Please check your inputs.');
    return;
  }

  // Calculate weight in kg (density is in g/cm³, so volume * density / 1000)
  const config = PRICING_CONFIG[material];
  const weightKg = (volumeCm3 * config.density) / 1000;

  // Calculate price
  let unitPrice = weightKg * config.pricePerKg;
  let totalPrice = unitPrice * quantity;

  // Apply minimum order surcharge if needed
  if (totalPrice < MINIMUM_ORDER.threshold) {
    totalPrice += MINIMUM_ORDER.surcharge;
  }

  // Display results in summary
  displaySummary(material, form, dimensions, unitPrice, totalPrice, weightKg, quantity, calcType);
  hideError();
}

// Display calculation summary
function displaySummary(material, form, dimensions, unitPrice, totalPrice, weight, quantity, calcType) {
  const materialSelect = document.getElementById('calc-material');
  const formSelect = document.getElementById('calc-form');
  const materialText = materialSelect.options[materialSelect.selectedIndex].text;
  const formText = formSelect.options[formSelect.selectedIndex].text;

  // Build dimension string
  let dimString = '';
  const template = DIMENSION_TEMPLATES[calcType];
  template.forEach((field, index) => {
    if (index > 0) dimString += ' × ';
    dimString += `${dimensions[field.id]}mm`;
  });

  // Update summary
  document.getElementById('summary-product').textContent = `${materialText}, ${formText}`;
  document.getElementById('summary-quantity').textContent = quantity;
  document.getElementById('summary-dimensions').textContent = dimString;
  document.getElementById('summary-weight').textContent = `${weight.toFixed(2)} kg`;
  document.getElementById('summary-unit-price').textContent = `€${unitPrice.toFixed(2)}`;
  document.getElementById('summary-total-price').textContent = `€${totalPrice.toFixed(2)}`;
  document.getElementById('calc-summary').style.display = 'block';
}

// Show error message
function showError(message) {
  const errorDiv = document.getElementById('calc-error');
  errorDiv.textContent = message;
  errorDiv.style.display = 'block';
  hideResult();
}

// Hide error message
function hideError() {
  document.getElementById('calc-error').style.display = 'none';
}

// Change quantity
function changeCalcQuantity(delta) {
  const input = document.getElementById('calc-quantity');
  const current = parseInt(input.value) || 1;
  const newValue = Math.max(1, current + delta);
  input.value = newValue;
  calculatePrice();
}

// Add calculated item to cart
function addCalculatedToCart() {
  const material = document.getElementById('calc-material');
  const form = document.getElementById('calc-form');
  const quantity = parseInt(document.getElementById('calc-quantity').value) || 1;

  // Get values from summary section
  const unitPrice = document.getElementById('summary-unit-price').textContent;
  const totalPrice = document.getElementById('summary-total-price').textContent;
  const weight = document.getElementById('summary-weight').textContent;
  const dimensions = document.getElementById('summary-dimensions').textContent;

  const materialText = material.options[material.selectedIndex].text;
  const formText = form.options[form.selectedIndex].text;

  const button = document.getElementById('calc-add-to-cart');
  const originalText = button.textContent;

  button.textContent = 'Adding...';
  button.disabled = true;

  // Note: Since this is a custom size, you'll need to create a generic "Custom Order" product
  // in Shopify and use its variant ID. The custom details will be added as line item properties.
  // For now, this shows an alert. You'll need to replace CUSTOM_PRODUCT_VARIANT_ID with actual ID.

  alert(`Custom Order Added!\n\nMaterial: ${materialText}\nForm: ${formText}\nDimensions: ${dimensions}\nWeight: ${weight}\nUnit Price: ${unitPrice}\nQuantity: ${quantity}\nTotal: ${totalPrice}\n\nTo enable actual cart functionality, create a "Custom Order" product in Shopify and update the calculator script with its variant ID.`);

  button.textContent = originalText;
  button.disabled = false;

  /* To enable actual cart functionality:

  1. Create a "Custom Order" product in Shopify
  2. Get its variant ID
  3. Replace 'YOUR_VARIANT_ID_HERE' below with the actual ID
  4. Comment out the alert above
  5. Uncomment this code:

  const CUSTOM_PRODUCT_VARIANT_ID = 'YOUR_VARIANT_ID_HERE';

  fetch('/cart/add.js', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      id: CUSTOM_PRODUCT_VARIANT_ID,
      quantity: quantity,
      properties: {
        'Material': materialText,
        'Form': formText,
        'Dimensions': dimensions,
        'Weight': weight,
        'Unit Price': unitPrice,
        'Total Price': totalPrice
      }
    })
  })
  .then(response => response.json())
  .then(data => {
    button.textContent = '✓ Added to Cart';
    setTimeout(() => {
      button.textContent = originalText;
      button.disabled = false;
    }, 2000);

    // Refresh page to update cart count
    setTimeout(() => {
      window.location.reload();
    }, 1500);
  })
  .catch(error => {
    console.error('Error:', error);
    button.textContent = 'Error - Try Again';
    setTimeout(() => {
      button.textContent = originalText;
      button.disabled = false;
    }, 2000);
  });
  */
}

// Event listeners
document.getElementById('calc-material').addEventListener('change', updateDimensionFields);
document.getElementById('calc-form').addEventListener('change', updateDimensionFields);
</script>

<style>
.metal-calculator {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 0;
  margin: 0;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  overflow: hidden;
}

/* Step styling */
.calc-step {
  padding: 32px;
  border-bottom: 1px solid #e5e7eb;
}

.calc-step:last-of-type {
  border-bottom: none;
}

.calc-step-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
}

.calc-step-number {
  width: 32px;
  height: 32px;
  background: #1f2937;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 16px;
  flex-shrink: 0;
}

.calc-step-title {
  font-size: 20px;
  font-weight: 700;
  margin: 0;
  color: #1f2937;
}

.calc-step-content {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* Field styling */
.calc-field {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.calc-label {
  font-size: 14px;
  font-weight: 600;
  color: #374151;
}

.calc-input {
  padding: 12px 16px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 16px;
  transition: all 0.2s;
  background: #f9fafb;
  color: #111827;
}

.calc-input:focus {
  outline: none;
  border-color: #6b7280;
  background: #ffffff;
}

.calc-select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23374151' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 40px;
}

.dimension-fields-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

/* Calculate button */
.calc-calculate-btn {
  width: 100%;
  padding: 14px 24px;
  background: #e5e7eb;
  color: #374151;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  transition: all 0.2s;
}

.calc-calculate-btn:hover {
  background: #d1d5db;
}

.calc-calculate-btn:active {
  background: #9ca3af;
}

/* Summary section */
.calc-summary {
  padding: 32px;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
}

.calc-summary-title {
  font-size: 20px;
  font-weight: 700;
  margin: 0 0 20px 0;
  color: #1f2937;
}

.calc-summary-content {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.calc-summary-product {
  font-size: 16px;
  color: #1f2937;
  margin: 0 0 12px 0;
  font-weight: 600;
}

.calc-summary-details {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.calc-summary-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 14px;
}

.calc-summary-label {
  color: #6b7280;
  font-weight: 500;
}

.calc-summary-value {
  color: #1f2937;
  font-weight: 600;
}

.calc-summary-total {
  margin-top: 8px;
  padding-top: 12px;
  border-top: 1px solid #d1d5db;
  font-size: 16px;
}

.calc-summary-total .calc-summary-label,
.calc-summary-total .calc-summary-value {
  font-weight: 700;
  color: #1f2937;
}

/* Add to Cart button */
.calc-add-to-cart-btn {
  width: 100%;
  padding: 16px 24px;
  background: #e5e7eb;
  color: #1f2937;
  border: none;
  border-radius: 48px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 700;
  transition: all 0.2s;
  text-transform: none;
}

.calc-add-to-cart-btn:hover:not(:disabled) {
  background: #d1d5db;
}

.calc-add-to-cart-btn:active:not(:disabled) {
  background: #9ca3af;
}

.calc-add-to-cart-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.calc-note {
  display: block;
  text-align: center;
  margin-top: 12px;
  font-size: 12px;
  color: #6b7280;
}

.calc-error {
  background: #fee2e2;
  border: 1px solid #f87171;
  border-radius: 6px;
  padding: 16px;
  margin: 16px 32px;
  color: #991b1b;
  font-weight: 500;
  font-size: 14px;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .calc-step {
    padding: 24px 20px;
  }

  .calc-step-title {
    font-size: 18px;
  }

  .calc-summary {
    padding: 24px 20px;
  }

  .dimension-fields-grid {
    grid-template-columns: 1fr;
  }

  .calc-error {
    margin: 16px 20px;
  }
}
</style>
